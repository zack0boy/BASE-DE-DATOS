<app-header></app-header>

<!-- Full width top bar (purple) -->
<div class="admin-top-bar">
  <div class="container-ancho">
    <h2 class="admin-top-bar-title">Panel Administrativo</h2>
  </div>
</div>

<main class="container-ancho py-4">
  <!-- Removed the extra 'Panel Administrativo' hero to use the shell's centered hero instead -->

  <app-loading-wrapper [loading]="loading" [error]="error" (reload)="loadAll()">
    <div class="manage-container">
      <!-- Shell with tabs, header and filter -->
      <app-admin-manage-shell
        [estudiantes]="estudiantes"
        [docentes]="docentes"
        [secretarias]="secretarias"
        [directores]="directores"
        [admins]="admins"
        [asignaturas]="asignaturas"
        [secciones]="secciones"
        [carreras]="carreras"
        [newAsignatura]="newAsignatura"
        [selectedAsignatura]="selectedAsignatura"
        [filteredAsignaturas]="filteredAsignaturas"
        [showAsignaturaDropdown]="showAsignaturaDropdown"
        (createUser)="openCreateUser()"
        (edit)="openEditUser($event)"
        (delete)="deleteUser($event)"
        (asignaturaChange)="changeUserAsignatura($event.user, $event.asignatura)"
        (createAsignatura)="createAsignatura()"
        (editAsignatura)="editAsignatura($event)"
        (deleteAsignatura)="deleteAsignatura($event)"
        (createCarrera)="createCarrera($event)"
        (editCarrera)="editCarrera($event)"
        (deleteCarrera)="deleteCarrera($event)"
        (createSection)="createSection($event)"
        (editSection)="editSection($event)"
        (deleteSection)="deleteSection($event)"
        (selectAsignatura)="selectAsignatura($event)">
      </app-admin-manage-shell>

    <!-- Sección de Asignaciones y Inscripciones -->
    <div *ngIf="selectedAsignatura" class="asignaciones-container mt-4">
      <div class="row">
        <!-- Panel de Asignaciones de Docentes -->
        <div class="col-lg-6 mb-4">
          <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">
                <i class="bi bi-person-chalkboard"></i> Docentes Asignados
              </h5>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label class="form-label">Asignar docente a esta asignatura:</label>
                <div class="input-group">
                  <select class="form-select" [(ngModel)]="selectedDocenteId">
                    <option [ngValue]="null">-- Seleccionar docente --</option>
                    <option *ngFor="let d of docentes" [ngValue]="d.id || d.id_usuario || d.idUsuario">
                      {{ d.nombre || d.name }} {{ d.apellido || d.lastName || '' }}
                    </option>
                  </select>
                  <button class="btn btn-primary" (click)="assignDocente()">
                    <i class="bi bi-plus-circle"></i> Asignar
                  </button>
                </div>
              </div>

              <div class="list-group">
                <div *ngIf="getAsignacionesForSelected().length === 0" class="alert alert-info mb-0">
                  No hay docentes asignados aún
                </div>
                <div
                  *ngFor="let asig of getAsignacionesForSelected()"
                  class="list-group-item d-flex justify-content-between align-items-center"
                >
                  <div>
                    <strong>{{ asig.usuario || asig.id_usuario || asig.user || asig.docente || asig.usuario_id || 'Usuario' }}</strong>
                  </div>
                  <button class="btn btn-sm btn-danger" (click)="removeAsignacion(asig)">
                    <i class="bi bi-trash"></i> Eliminar
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Panel de Inscripciones de Estudiantes -->
        <div class="col-lg-6 mb-4">
          <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
              <h5 class="mb-0">
                <i class="bi bi-people"></i> Estudiantes Inscritos
              </h5>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label class="form-label">Inscribir estudiante en esta asignatura:</label>
                <div class="input-group">
                  <select class="form-select" [(ngModel)]="selectedEstudianteId">
                    <option [ngValue]="null">-- Seleccionar estudiante --</option>
                    <option *ngFor="let s of estudiantes" [ngValue]="s.id || s.id_usuario || s.idUsuario">
                      {{ s.nombre || s.name }} {{ s.apellido || s.lastName || '' }}
                    </option>
                  </select>
                  <button class="btn btn-success" (click)="assignEstudiante()">
                    <i class="bi bi-plus-circle"></i> Inscribir
                  </button>
                </div>
              </div>

              <div class="list-group">
                <div *ngIf="getInscripcionesForSelected().length === 0" class="alert alert-info mb-0">
                  No hay estudiantes inscritos aún
                </div>
                <div
                  *ngFor="let insu of getInscripcionesForSelected()"
                  class="list-group-item d-flex justify-content-between align-items-center"
                >
                  <div>
                    <strong>{{ insu.usuario || insu.id_usuario || insu.user || insu.usuario_id || 'Usuario' }}</strong>
                  </div>
                  <button class="btn btn-sm btn-danger" (click)="removeInscripcion(insu)">
                    <i class="bi bi-trash"></i> Eliminar
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL: Editar Carrera -->
    <div *ngIf="showCarreraEditModal" class="modal-overlay" (click)="closeCarreraEditModal()">
      <div class="modal-content-modern" (click)="$event.stopPropagation()">
        <div class="modal-header bg-gradient-primary text-white border-0">
          <h5 class="modal-title"><i class="bi bi-pencil"></i> Editar Carrera</h5>
          <button type="button" class="btn-close btn-close-white" (click)="closeCarreraEditModal()"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-600">Nombre de la Carrera</label>
            <input type="text" class="form-control form-control-modern" [(ngModel)]="newCarrera.nombre" placeholder="Ej: Ingeniería en Sistemas">
          </div>
          <div class="mb-3">
            <label class="form-label fw-600">Código</label>
            <input type="text" class="form-control form-control-modern" [(ngModel)]="newCarrera.codigo" placeholder="Código">
          </div>
          <div class="mb-3">
            <label class="form-label fw-600">Descripción</label>
            <textarea class="form-control form-control-modern" [(ngModel)]="newCarrera.descripcion" rows="3" placeholder="Descripción de la carrera"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label fw-600">Duración (semestres)</label>
            <input type="number" class="form-control form-control-modern" [(ngModel)]="newCarrera.duracion" placeholder="8" min="1" max="16">
          </div>
        </div>
        <div class="modal-footer bg-light border-top">
          <button type="button" class="btn btn-outline-secondary btn-modern" (click)="closeCarreraEditModal()">Cancelar</button>
          <button type="button" class="btn btn-primary btn-modern btn-lg" (click)="saveCarrera()">
            <i class="bi bi-check-circle"></i> Guardar Cambios
          </button>
        </div>
      </div>
    </div>
    <div *ngIf="showCarreraEditModal" class="modal-backdrop"></div>

    <!-- MODAL: Editar Sección -->
    <div *ngIf="showSeccionEditModal" class="modal-overlay" (click)="closeSeccionEditModal()">
      <div class="modal-content-modern" (click)="$event.stopPropagation()">
        <div class="modal-header bg-gradient-primary text-white border-0">
          <h5 class="modal-title"><i class="bi bi-pencil"></i> Editar Sección</h5>
          <button type="button" class="btn-close btn-close-white" (click)="closeSeccionEditModal()"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-600">Nombre de la Sección</label>
            <input type="text" class="form-control form-control-modern" [(ngModel)]="newSeccion.nombre" placeholder="Ej: Sección A">
          </div>
          <div class="mb-3">
            <label class="form-label fw-600">Asignatura</label>
            <select class="form-select form-control-modern" [(ngModel)]="newSeccion.asignatura_id">
              <option [value]="null">Seleccionar asignatura</option>
              <option *ngFor="let a of asignaturas" [value]="a.id || a.idAsignatura || a.id_asignatura">{{ a.nombre }}</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label fw-600">Carrera</label>
            <select class="form-select form-control-modern" [(ngModel)]="newSeccion.carrera_id">
              <option [value]="null">Seleccionar carrera</option>
              <option *ngFor="let c of carreras" [value]="c.id || c.idCarrera || c.id_carrera">{{ c.nombre }}</option>
            </select>
          </div>
        </div>
        <div class="modal-footer bg-light border-top">
          <button type="button" class="btn btn-outline-secondary btn-modern" (click)="closeSeccionEditModal()">Cancelar</button>
          <button type="button" class="btn btn-primary btn-modern btn-lg" (click)="saveSection()">
            <i class="bi bi-check-circle"></i> Guardar Cambios
          </button>
        </div>
      </div>
    </div>
    <div *ngIf="showSeccionEditModal" class="modal-backdrop"></div>

    <!-- MODAL: Editar Asignatura -->
    <div *ngIf="showAsignaturaEditModal" class="modal-overlay" (click)="closeAsignaturaEditModal()">
      <div class="modal-content-modern" (click)="$event.stopPropagation()">
        <div class="modal-header bg-gradient-primary text-white border-0">
          <h5 class="modal-title"><i class="bi bi-pencil"></i> Editar Asignatura</h5>
          <button type="button" class="btn-close btn-close-white" (click)="closeAsignaturaEditModal()"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-600">Nombre de la Asignatura</label>
            <input type="text" class="form-control form-control-modern" [(ngModel)]="editAsignaturaData.nombre" placeholder="Ej: Matemática I">
          </div>
          <div class="mb-3">
            <label class="form-label fw-600">Código</label>
            <input type="text" class="form-control form-control-modern" [(ngModel)]="editAsignaturaData.codigo" placeholder="Código">
          </div>
          <div class="mb-3">
            <label class="form-label fw-600">Horas</label>
            <input type="number" class="form-control form-control-modern" [(ngModel)]="editAsignaturaData.horas" placeholder="0" min="0">
          </div>
          <div class="mb-3">
            <label class="form-label fw-600">Descripción</label>
            <textarea class="form-control form-control-modern" [(ngModel)]="editAsignaturaData.descripcion" rows="3" placeholder="Descripción de la asignatura"></textarea>
          </div>
        </div>
        <div class="modal-footer bg-light border-top">
          <button type="button" class="btn btn-outline-secondary btn-modern" (click)="closeAsignaturaEditModal()">Cancelar</button>
          <button type="button" class="btn btn-primary btn-modern btn-lg" (click)="saveAsignatura()">
            <i class="bi bi-check-circle"></i> Guardar Cambios
          </button>
        </div>
      </div>
    </div>
    <div *ngIf="showAsignaturaEditModal" class="modal-backdrop"></div>

    <!-- MODAL: Editar Usuario (reutilizable) -->
    <div *ngIf="showUserForm" class="modal-overlay" (click)="cancelUserForm()">
      <div class="modal-content-modern" (click)="$event.stopPropagation()">
        <div class="modal-header bg-gradient-primary text-white border-0">
          <h5 class="modal-title"><i class="bi bi-person-lines-fill"></i> {{ editingUser ? 'Editar Usuario' : 'Editar Usuario' }}</h5>
          <button type="button" class="btn-close btn-close-white" (click)="cancelUserForm()"></button>
        </div>
        <div class="modal-body">
          <div class="row g-2">
            <div class="col-6 mb-3">
              <label class="form-label fw-600">Nombre</label>
              <input type="text" class="form-control form-control-modern" [(ngModel)]="newUser.nombre" placeholder="Nombre">
            </div>
            <div class="col-6 mb-3">
              <label class="form-label fw-600">Apellido</label>
              <input type="text" class="form-control form-control-modern" [(ngModel)]="newUser.apellido" placeholder="Apellido">
            </div>
            <div class="col-6 mb-3">
              <label class="form-label fw-600">Email</label>
              <input type="email" class="form-control form-control-modern" [(ngModel)]="newUser.email" placeholder="email@dominio">
            </div>
            <div class="col-6 mb-3">
              <label class="form-label fw-600">RUT / Cédula</label>
              <input type="text" class="form-control form-control-modern" [(ngModel)]="newUser.rut" placeholder="RUT">
            </div>
            <div class="col-6 mb-3">
              <label class="form-label fw-600">Rol</label>
              <select class="form-select form-control-modern" [(ngModel)]="newUser.id_rol">
                <option [value]="41">Estudiante</option>
                <option [value]="42">Docente</option>
                <option [value]="43">Secretaria</option>
                <option [value]="44">Director</option>
                <option [value]="45">Admin</option>
              </select>
            </div>
            <div class="col-6 mb-3">
              <label class="form-label fw-600">Asignatura</label>
              <select class="form-select form-control-modern" [(ngModel)]="newUser.asignatura_id">
                <option [value]="null">-- Ninguna --</option>
                <option *ngFor="let a of asignaturas" [value]="a.id || a.idAsignatura || a.id_asignatura">{{ a.nombre }}</option>
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer bg-light border-top">
          <button type="button" class="btn btn-outline-secondary btn-modern" (click)="cancelUserForm()">Cancelar</button>
          <button type="button" class="btn btn-primary btn-modern btn-lg" (click)="saveUser()">
            <i class="bi bi-check-circle"></i> Confirmar cambios
          </button>
        </div>
      </div>
    </div>
    <div *ngIf="showUserForm" class="modal-backdrop"></div>

    <!-- Mensajes de feedback -->
    <div *ngIf="message" class="alert alert-info mt-4" role="alert">
      <i class="bi bi-info-circle"></i> {{ message }}
    </div>

    <app-temp-password-modal
      [visible]="showTempPasswordModal"
      [password]="tempPasswordValue"
      (copied)="message='Clave temporal copiada al portapapeles'"
      (closed)="closeTempPasswordModal()">
    </app-temp-password-modal>

    </div>
  </app-loading-wrapper>
</main>
<app-footer></app-footer>
